name: OnePlus_PadPro_Full_Ultimate_Build

on:
  workflow_dispatch:
    inputs:
      custom_command:
        description: 'ç¼–è¯‘æŒ‡ä»¤'
        required: true
        default: 'python3 kernel_platform/build_with_bazel.py -t pineapple gki'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æè‡´ç£ç›˜æ¸…ç†
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: 2. æ£€å‡ºä¸åŒæ­¥æºç 
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "KernelBot"
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH="$HOME/bin:$PATH"
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/${{ github.repository }}.git -b main -m manifest.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync

      - name: 3. äº”ç»´åº¦å…¨èƒ½ä¼˜åŒ–æ³¨å…¥ (æºç çº§ç¡¬ç¼–ç )
        run: |
          cd workspace/kernel_platform/common
          echo "ğŸŒŸ å¯åŠ¨äº”ç»´åº¦å…¨èƒ½ä¼˜åŒ–æ³¨å…¥..."

          # --- 1. ç½‘ç»œä¼˜åŒ– (BBRv3 + FQ-Codel) ---
          if [ -f "net/ipv4/Kconfig" ]; then
            sed -i 's/default "cubic"/default "bbrv3"/' net/ipv4/Kconfig
            sed -i 's/default TCP_CONG_CUBIC/default TCP_CONG_BBRV3/' net/ipv4/Kconfig
            echo "âœ… ç½‘ç»œåŠ é€Ÿæ³¨å…¥å®Œæˆ"
          fi

          # --- 2. å†…å­˜ä¼˜åŒ– (MGLRU é»˜è®¤å¼€å¯) ---
          if [ -f "mm/Kconfig" ]; then
            sed -i '/config LRU_GEN$/,/bool/s/bool "Multi-Gen LRU"/bool "Multi-Gen LRU"\n\tdefault y/' mm/Kconfig
            echo "âœ… å†…å­˜ä¿æ´»æ³¨å…¥å®Œæˆ"
          fi

          # --- 3. æ€§èƒ½ä¼˜åŒ– (1000Hz å“åº” + WALT è°ƒåº¦) ---
          find . -name "Kconfig*" -exec sed -i 's/default 250/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/default 300/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/bool "WALT scheduler"/bool "WALT scheduler"\n\tdefault y/' {} +
          echo "âœ… æ€§èƒ½å“åº”æ³¨å…¥å®Œæˆ"

          # --- 4. å½±åƒä¼˜åŒ– (æå‡ ISP ååä¼˜å…ˆçº§) ---
          find drivers/media -name "Kconfig*" -exec sed -i 's/bool "Qualcomm Technologies, Inc. MSM Camera"/bool "Qualcomm Technologies, Inc. MSM Camera"\n\tdefault y/' {} +
          echo "âœ… å½±åƒä¼˜åŒ–æ³¨å…¥å®Œæˆ"

          # --- 5. ç»­èˆªä¼˜åŒ– (æé€Ÿæ·±åº¦ç¡çœ é€»è¾‘) ---
          if [ -f "kernel/power/Kconfig" ]; then
            sed -i 's/bool "Suspend to RAM and standby"/bool "Suspend to RAM and standby"\n\tdefault y/' kernel/power/Kconfig
          fi
          echo "âœ… ç»­èˆªä¼˜åŒ–æ³¨å…¥å®Œæˆ"

          # --- 6. ç‰©ç†å±è”½ Bazel æ‹¦æˆªé€»è¾‘ (ç¡®ä¿ç¼–è¯‘ä¸ä¸­æ–­) ---
          find ../build/kernel/kleaf -name "*.bzl" -exec sed -i 's/fail(/print(/g' {} +
          find ../build/kernel/kleaf -name "*.sh" -exec sed -i 's/exit 1/echo/g' {} +

      - name: 4. æ‰§è¡Œå…¨ä¼˜åŒ–ç¼–è¯‘
        continue-on-error: true
        run: |
          export PATH="$HOME/bin:$PATH"
          export SKIP_ABI_CHECK=1
          export SKIP_IF_SAVEDEFCONFIG_DOES_NOT_MATCH=1
          cd workspace
          ${{ github.event.inputs.custom_command }} -- \
            --action_env=SKIP_ABI_CHECK=1 \
            --action_env=SKIP_IF_SAVEDEFCONFIG_DOES_NOT_MATCH=1 \
            --define=ABIDW=false

      - name: 5. æ·±åº¦æŒ–æ˜é•œåƒå¹¶æ‰“åŒ…
        run: |
          echo "ğŸ” æ­£åœ¨å…¨é‡æŒ–æ˜å†…æ ¸é•œåƒ..."
          cd workspace
          # åœ¨æ•´ä¸ª kernel_platform ç›®å½•ä¸‹å¯»æ‰¾æœ€æ–°çš„äºŒè¿›åˆ¶ Image
          IMAGE_PATH=$(find kernel_platform -name "Image" -o -name "Image.gz" | grep "pineapple" | head -n 1)
          
          if [ -z "$IMAGE_PATH" ]; then
            IMAGE_PATH=$(find . -maxdepth 10 -name "Image" | grep -v ".repo" | head -n 1)
          fi

          if [ -n "$IMAGE_PATH" ]; then
            echo "âœ… æˆåŠŸæŒ–æ˜åˆ°é•œåƒ: $IMAGE_PATH"
            ABS_IMAGE=$(realpath "$IMAGE_PATH")
            cd ..
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
            cp "$ABS_IMAGE" ak3/Image
            cd ak3
            # ä¿®æ”¹ AnyKernel3 è„šæœ¬ä»¥åŒ¹é…ä½ çš„è®¾å¤‡
            sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/' anykernel.sh
            zip -r9 ../OnePlus_PadPro_Ultimate_All_In_One.zip *
          else
            echo "âŒ ä»æœªæ‰¾åˆ°é•œåƒï¼Œè¯·æ£€æŸ¥ç¼–è¯‘é˜¶æ®µæ—¥å¿—"
            exit 1
          fi

      - name: 6. ä¸Šä¼ æœ€ç»ˆæˆå“
        uses: actions/upload-artifact@v4
        with:
          name: Full_Ultimate_Kernel
          path: "*.zip"