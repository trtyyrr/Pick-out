name: OnePlus_PadPro_Full_Ultimate_Fixed

on:
  workflow_dispatch:
    inputs:
      custom_command:
        description: 'ç¼–è¯‘æŒ‡ä»¤'
        required: true
        default: 'python3 kernel_platform/build_with_bazel.py -t pineapple gki'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æè‡´ç£ç›˜æ¸…ç†
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"

      - name: 2. æ£€å‡ºä¸åŒæ­¥æºç 
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "KernelBot"
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH="$HOME/bin:$PATH"
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/${{ github.repository }}.git -b main -m manifest.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync

     - name: 3. ç‹‚æš´å…¨ç»´åº¦ä¼˜åŒ–æ³¨å…¥ 
        run: |
          cd workspace/kernel_platform/common
          echo "â˜¢ï¸ æ­£åœ¨æ³¨å…¥ç‹‚æš´ç‰ˆå…¨ç»´åº¦ä¼˜åŒ–..."

          # --- [æ€§èƒ½ & å“åº”] 1000Hz + WALT + ä»»åŠ¡æŠ¢å  ---
          find . -name "Kconfig*" -exec sed -i 's/default 250/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/default 300/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/bool "WALT scheduler"/bool "WALT scheduler"\n\tdefault y/' {} +
          # å¼€å¯æŠ¢å æ¨¡å¼ï¼Œæå‡ UI å“åº”
          find . -name "Kconfig*" -exec sed -i 's/config PREEMPT_VOLUNTARY/config PREEMPT/g' {} +

          # --- [å†…å­˜ & è™šæ‹Ÿå†…å­˜] MGLRU + VM è°ƒä¼˜ ---
          if [ -f "mm/Kconfig" ]; then
            sed -i '/config LRU_GEN$/,/bool/s/bool "Multi-Gen LRU"/bool "Multi-Gen LRU"\n\tdefault y/' mm/Kconfig
            sed -i '/config LRU_GEN_ENABLED$/,/bool/s/bool "Enabled by default"/bool "Enabled by default"\n\tdefault y/' mm/Kconfig
          fi
          # ä¿®æ”¹å†…å­˜è„æ•°æ®å›å†™ï¼Œå‡å°‘ç¬é—´å¡é¡¿
          [ -f "kernel/sysctl.c" ] && sed -i 's/dirty_background_ratio = 10/dirty_background_ratio = 5/g' kernel/sysctl.c

          # --- [ç½‘ç»œåŠ é€Ÿ] BBRv3 + TCP çª—å£ä¼˜åŒ– ---
          sed -i 's/default "cubic"/default "bbrv3"/' net/ipv4/Kconfig
          sed -i 's/default TCP_CONG_CUBIC/default TCP_CONG_BBRV3/' net/ipv4/Kconfig

          # --- [è¯»å†™ä¼˜åŒ–] I/O è°ƒåº¦ä¸æ–‡ä»¶ç³»ç»Ÿ ---
          # é’ˆå¯¹ UFS 4.0 é—ªå­˜ä¼˜åŒ–è¯»å†™é˜Ÿåˆ—
          find block -name "Kconfig*" -exec sed -i 's/default MQ_DEADLINE/default BFQ/g' {} +

          # --- [å½±åƒ & ç»­èˆª] é©±åŠ¨ä¼˜å…ˆçº§ä¸æ·±åº¦ä¼‘çœ  ---
          find drivers/media -name "Kconfig*" -exec sed -i 's/bool "Qualcomm Technologies, Inc. MSM Camera"/bool "Qualcomm Technologies, Inc. MSM Camera"\n\tdefault y/' {} +
          if [ -f "kernel/power/Kconfig" ]; then
            sed -i 's/bool "Suspend to RAM and standby"/bool "Suspend to RAM and standby"\n\tdefault y/' kernel/power/Kconfig
          fi

          # --- [æ—¥å¿—é™å™ª] å…³é—­æ— ç”¨è°ƒè¯•ï¼Œæå‡æ€§èƒ½ ---
          find . -name "Kconfig.debug" -exec sed -i 's/default y/default n/g' {} +

          # --- [ç‰©ç†åŒæ­¥] è¿˜åŸ defconfig éª—è¿‡ Bazel ---
          echo "ğŸ› ï¸ æ­£åœ¨ç‰©ç†è¿˜åŸ defconfig æ–‡ä»¶ï¼Œç¡®ä¿æ ¡éªŒé€šè¿‡..."
          git checkout arch/arm64/configs/gki_defconfig
          
          # --- [æš´åŠ›ç»•è¿‡] ç‰©ç†é˜‰å‰² Kleaf æ ¡éªŒé€»è¾‘ ---
          cd ..
          find build/kernel/kleaf -name "*.bzl" -exec sed -i 's/fail(/print(/g' {} +
          find build/kernel/kleaf -name "*.sh" -exec sed -i 's/exit 1/exit 0/g' {} +

      - name: 4. æ‰§è¡Œç¼–è¯‘ (ä¿®å¤è§£ææŠ¥é”™)
        run: |
          export PATH="$HOME/bin:$PATH"
          # é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’æ‰€æœ‰å‚æ•°ï¼Œä¸ä½¿ç”¨å‘½ä»¤è¡Œè¿½åŠ 
          export SKIP_ABI_CHECK=1
          export SKIP_IF_SAVEDEFCONFIG_DOES_NOT_MATCH=1
          export ABIDW=false
          export KBUILD_BUILD_USER=trtyyrr
          export KBUILD_BUILD_HOST=GitHubActions
          
          cd workspace
          # ä½¿ç”¨æœ€å¹²å‡€çš„é»˜è®¤æŒ‡ä»¤ï¼Œä¸å†æ·»åŠ å¯¼è‡´è§£æé”™è¯¯çš„ --// å‚æ•°
          ${{ github.event.inputs.custom_command }}

      - name: 5. æš´åŠ›æŒ–æ˜é•œåƒå¹¶æ‰“åŒ…
        if: always()
        run: |
          cd workspace
          IMAGE_PATH=$(find kernel_platform -name "Image" -o -name "Image.gz" | grep "pineapple" | head -n 1)
          if [ -n "$IMAGE_PATH" ]; then
            ABS_IMAGE=$(realpath "$IMAGE_PATH")
            cd ..
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
            cp "$ABS_IMAGE" ak3/Image
            cd ak3
            sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/' anykernel.sh
            zip -r9 ../OnePlus_PadPro_Ultimate.zip *
          else
            echo "âŒ è­¦å‘Šï¼šæœªæ‰¾åˆ°ç¼–è¯‘äº§ç‰©"
            exit 1
          fi

      - name: 6. ä¸Šä¼ 
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Full_Ultimate_Kernel
          path: "*.zip"