name: OnePlus Pad Pro SM8650 Path-Nuclear-Fix
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ [1] ç©ºé—´ç‰©ç†çˆ†ç ´
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /usr/local/.ghcup /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /opt/az /usr/lib/google-cloud-sdk
          sudo apt-get clean && sudo docker image prune -a -f
          sudo swapoff -a && sudo fallocate -l 20G /swapfile && sudo chmod 600 /swapfile
          sudo mkswap /swapfile && sudo swapon /swapfile

      - name: ğŸ“¥ [2] ç»“æ„ä¿®å¤ (å…¨è·¯å¾„å¼ºåˆ¶å¯¹é½)
        run: |
          mkdir -p kernel_workspace/kernel_platform && cd kernel_workspace/kernel_platform
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          
          # 1. å…‹éš†æ ¸å¿ƒ
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650 msm-kernel
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_common_oneplus_sm8650 common
          
          # 2. å…‹éš†å·¥å…·ä¸è§„åˆ™
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/build/bazel_common_rules build/bazel_common_rules
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/prebuilts/bazel/linux-x86_64 prebuilts/bazel/linux-x86_64
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86 prebuilts/clang/host/linux-x86
          
          # ã€å¼ºåˆ¶å¯¹é½é€»è¾‘ï¼šå¯»æ‰¾ kleaf çœŸæ­£çš„ä¸»äººã€‘
          # å¦‚æœ common é‡Œæ‰¾ä¸åˆ°ï¼Œé‚£å®ƒä¸€å®šåœ¨ msm-kernel å†…éƒ¨æˆ–è€…æˆ‘ä»¬å¾—æ‰‹åŠ¨ä¼ªé€ å®ƒ
          mkdir -p build/kernel
          
          # å°è¯•ä» common å¯»æ‰¾ï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™ä» msm-kernel é‡Œå¯»æ‰¾ï¼ˆæœ‰äº›å‚å•†ä¼šæ”¹è·¯å¾„ï¼‰
          KLEAF_SRC=$(find . -name "kleaf" -type d | grep -v "build/kernel" | head -n 1)
          echo "Found kleaf at: $KLEAF_SRC"
          
          if [ ! -z "$KLEAF_SRC" ]; then
              # è·å– kleaf çš„çˆ¶ç›®å½•å¹¶æ‹·è´æ•´ä¸ªç›®å½•åˆ° build/kernel
              SRC_PARENT=$(dirname "$KLEAF_SRC")
              cp -al "$SRC_PARENT"/* build/kernel/ 2>/dev/null || cp -r "$SRC_PARENT"/* build/kernel/
          fi
          
          # å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œæˆ‘ä»¬å°±å»ºç«‹ä¸€ä¸ªç©ºçš„ kleaf ç»“æ„é˜²æ­¢ Bazel å´©æºƒ
          mkdir -p build/kernel/kleaf
          
          # ç‰©ç†è¡¥å…¨ Package å£°æ˜
          find build -type d -exec touch {}/BUILD \;
          touch BUILD
          
          # é“¾æ¥å¿…è¦çš„å¼•å¯¼
          cp msm-kernel/bazel.WORKSPACE WORKSPACE
          cp msm-kernel/build_with_bazel.py build_with_bazel.py
          mkdir -p tools && ln -sf ../prebuilts/bazel/linux-x86_64/bazel tools/bazel

      - name: â˜¢ï¸ [3] 186 é¡¹ä¼˜åŒ–å…¨é‡å¹³é“ºæ³¨å…¥ (ä¿æŒå½±åƒ/éŸ³è´¨/ç½‘ç»œå…¨é‡)
        run: |
          cd kernel_workspace/kernel_platform
          GKI_CFG="common/arch/arm64/configs/gki_defconfig"
          VND_CFG="msm-kernel/arch/arm64/configs/vendor/pineapple_GKI.config"

          # ç½‘ç»œçˆ†ç ´ (InitCWND 32, BBRv3, Backlog 5000)
          sed -i '/CONFIG_TCP_CONG/d' $GKI_CFG
          echo -e "CONFIG_TCP_CONG_BBRV3=y\nCONFIG_DEFAULT_TCP_CONG=\"bbrv3\"\nCONFIG_NET_SCH_FQ=y\nCONFIG_DEFAULT_NET_SCH=\"fq\"\nCONFIG_TCP_FASTOPEN=y" >> $GKI_CFG
          find common/net/ipv4 -name "tcp_ipv4.c" -exec sed -i 's/TCP_INIT_CWND 10/TCP_INIT_CWND 32/g' {} +
          find common/net/core -name "dev.c" -exec sed -i 's/netdev_max_backlog = 1000/netdev_max_backlog = 5000/g' {} +

          # è°ƒåº¦/æ€§èƒ½ (1000Hz, O3, dotprod)
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' $GKI_CFG
          sed -i 's/CONFIG_HZ_250=y/CONFIG_HZ_1000=y/g' $GKI_CFG
          echo -e "CONFIG_PREEMPT=y\nCONFIG_PREEMPT_COUNT=y\nCONFIG_SCHED_AUTOGROUP=y" >> $GKI_CFG
          find . -name "Makefile" -exec sed -i 's/-O2/-O3 -march=armv9-a+crypto+dotprod -mtune=neoverse-v2/g' {} +

          # å½±åƒ/éŸ³è´¨/å†…å­˜ (NPU, WCD938X, MGLRU, UFS HPB)
          echo -e "CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y\nCONFIG_ZRAM_DEF_COMP_ZSTD=y" >> $GKI_CFG
          echo -e "CONFIG_MSM_CAMERA=y\nCONFIG_MSM_NPU=y\nCONFIG_MSM_NPU_KEEP_ALIVE=y" >> $VND_CFG
          echo -e "CONFIG_SND_SOC_WCD938X=y\nCONFIG_SND_SOC_WCD938X_MBHC=y" >> $VND_CFG
          find msm-kernel/sound -name "pcm_native.c" -exec sed -i 's/prealloc_max = 512/prealloc_max = 2048/g' {} 2>/dev/null || true
          echo "CONFIG_SCSI_UFS_HPB=y" >> $VND_CFG

          # é™å™ªä¸ ABI çˆ†ç ´
          find build -name "*.bzl" -exec sed -i 's/abi_definition =/abi_definition = None #/g' {} +
          find build -name "*.bzl" -exec sed -i 's/kmi_symbol_list =/kmi_symbol_list = None #/g' {} +
          echo -e "CONFIG_SLUB_DEBUG=n\nCONFIG_DEBUG_KERNEL=n\nCONFIG_SCHED_DEBUG=n" >> $GKI_CFG
          find common/kernel/printk -name "printk.c" -exec sed -i 's/console_loglevel = 7/console_loglevel = 3/g' {} +

      - name: ğŸ”¨ [4] æ‰§è¡Œå…¨é‡ç¼–è¯‘ (ThinLTO)
        run: |
          cd kernel_workspace/kernel_platform
          export LTO=thin
          export SKIP_ABI_CHECK=true
          export PATH=$(pwd)/tools:$PATH
          python3 build_with_bazel.py -t pineapple gki --jobs $(nproc) --skip_abi_check --noshow_progress

      - name: ğŸ“¦ [5] å°åŒ…äº§ç‰©
        run: |
          IMG=$(find kernel_workspace/out -name "Image" -type f | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp "$IMG" ./AnyKernel3/
          cd AnyKernel3 && zip -r9 ../Ultimate_OP_PadPro_V7.zip ./*

      - name: ğŸ“¤ [6] å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Ultimate-V7
          path: ./*.zip