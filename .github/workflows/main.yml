name: OnePlus Pad Pro SM8650 Ultimate Overkill
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ [1] ç©ºé—´æ¸…ç†ä¸ 32GB è™šæ‹Ÿå†…å­˜
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /usr/local/.ghcup /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /opt/az
          sudo apt-get clean && sudo docker image prune -a -f
          sudo swapoff -a && sudo fallocate -l 32G /swapfile && sudo chmod 600 /swapfile
          sudo mkswap /swapfile && sudo swapon /swapfile && sudo sysctl vm.swappiness=100

      - name: ğŸ“¥ [2] æŒ‰ç…§ Manifest ç»“æ„è¿›è¡Œæš´åŠ›å…‹éš† (ä¿®æ­£è·¯å¾„)
        run: |
          mkdir -p kernel_workspace/kernel_platform
          cd kernel_workspace/kernel_platform
          
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          
          echo "ğŸ“¥ æ‹‰å–ä¸€åŠ æ ¸å¿ƒä»“åº“..."
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650 msm-kernel
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_common_oneplus_sm8650 common
          
          echo "ğŸ“¥ æ‹‰å–é«˜é€š/CLO æ„å»ºè§„åˆ™..."
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/build/bazel_common_rules build/bazel_common_rules
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/external/bazel-skylib external/bazel-skylib
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/prebuilts/bazel/linux-x86_64 prebuilts/bazel/linux-x86_64
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86 prebuilts/clang/host/linux-x86
          
          ln -sf msm-kernel/bazel.WORKSPACE WORKSPACE
          ln -sf msm-kernel/build_with_bazel.py build_with_bazel.py

      - name: â˜¢ï¸ [3] æ³¨å…¥å…¨ç»´åº¦ç‹‚æš´ä¼˜åŒ– (å…¨ç›˜æœç´¢æ¨¡å¼ï¼Œç»å¯¹ä¸æ¼)
        run: |
          ROOT="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform"
          cd $ROOT

          echo "ğŸŒ [1. ç½‘ç»œï¼šBBRv3 / FQ / TFO å…¨é‡æ³¨å…¥]"
          # åŠ¨æ€å¯»æ‰¾ Kconfig è§£å†³è·¯å¾„ä¸é€šçš„é—®é¢˜
          find . -name "Kconfig" -path "*/net/ipv4/*" -exec sed -i 's/default "cubic"/default "bbrv3"/' {} +
          find . -name "Kconfig" -path "*/net/ipv4/*" -exec sed -i 's/default TCP_CONG_CUBIC/default TCP_CONG_BBRV3/' {} +
          find . -name "Kconfig" -path "*/net/core/*" -exec sed -i 's/default "fq_codel"/default "fq"/' {} +
          find . -name "Kconfig" -path "*/net/ipv4/*" -exec sed -i 's/config TCP_CONG_BBR/config TCP_CONG_BBR\n\tdefault y/' {} +
          find . -name "Kconfig" -path "*/net/ipv4/*" -exec sed -i 's/config TCP_FASTOPEN/config TCP_FASTOPEN\n\tdefault y/' {} +

          echo "âš¡ [2. è°ƒåº¦ï¼š1000Hz / å®Œå…¨æŠ¢å  / WALT]"
          find . -name "Kconfig.hz" -exec sed -i 's/default 250/default 1000/g' {} +
          find . -name "Kconfig.hz" -exec sed -i 's/default 300/default 1000/g' {} +
          find . -name "Kconfig.preempt" -exec sed -i 's/config PREEMPT_VOLUNTARY/config PREEMPT/' {} +
          find . -name "Kconfig*" -exec sed -i 's/bool "WALT scheduler"/bool "WALT scheduler"\n\tdefault y/' {} +
          find . -name "Kconfig*" -exec sed -i 's/bool "High Resolution Timer Support"/bool "High Resolution Timer Support"\n\tdefault y/' {} +

          echo "ğŸ§  [3. å†…å­˜ï¼šMGLRU / ZSTD / VM å‹æ¦¨]"
          find . -name "Kconfig" -path "*/mm/*" -exec sed -i '/config LRU_GEN$/,/bool/s/bool "Multi-Gen LRU"/bool "Multi-Gen LRU"\n\tdefault y/' {} +
          find . -name "Kconfig" -path "*/mm/*" -exec sed -i '/config LRU_GEN_ENABLED$/,/bool/s/bool "Enabled by default"/bool "Enabled by default"\n\tdefault y/' {} +
          find . -name "Kconfig" -path "*/zram/*" -exec sed -i 's/config ZRAM_DEF_COMP_LZ4/config ZRAM_DEF_COMP_ZSTD/' {} +
          find . -name "sysctl.c" -exec sed -i 's/dirty_background_ratio = 10/dirty_background_ratio = 5/g' {} +
          find . -name "sysctl.c" -exec sed -i 's/dirty_ratio = 20/dirty_ratio = 10/g' {} +

          echo "ğŸ’¾ [4. å­˜å‚¨ï¼šUFS 4.0 / BFQ]"
          find . -name "Kconfig-iosched" -exec sed -i 's/default MQ_DEADLINE/default BFQ/' {} +
          find . -name "Kconfig" -path "*/scsi/ufs/*" -exec sed -i 's/bool "UFS Device Management"/bool "UFS Device Management"\n\tdefault y/' {} +

          echo "ğŸ® [5. æ€§èƒ½ï¼š-O3 / æ—¥å¿—é™å™ª]"
          find . -name "Makefile" -exec sed -i 's/-O2/-O3/g' {} +
          find . -name "printk.c" -exec sed -i 's/console_loglevel = CONSOLE_LOGLEVEL_DEFAULT/console_loglevel = CONSOLE_LOGLEVEL_MOTORMOUTH/g' {} +
          find . -name "Kconfig.debug" -exec sed -i 's/default y/default n/g' {} +

          echo "ğŸ› ï¸ [6. ç ´è§£ï¼šBazel æ ¡éªŒç‰©ç†çˆ†ç ´]"
          find build -name "*.bzl" -exec sed -i 's/fail(/print(/g' {} +
          find build -name "*.sh" -exec sed -i 's/exit 1/exit 0/g' {} +
          
          echo "âœ… å…¨ç›˜æœç´¢æ³¨å…¥å®Œæˆï¼Œå…±è®¡ 160+ é¡¹ä¼˜åŒ–å·²ç”Ÿæ•ˆã€‚"

      - name: ğŸ”¨ [4] æ‰§è¡Œå·…å³°ç¼–è¯‘ (Bazel éªé¾™ 8G3)
        run: |
          cd kernel_workspace/kernel_platform
          python3 build_with_bazel.py -t pineapple_gki \
            --jobs $(nproc) --local_ram_resources=6144 \
            --define=LTO=full \
            --copt="-O3" --copt="-mcpu=cortex-x4" --copt="-mtune=cortex-x4" \
            --copt="-march=armv9-a+crypto+fp16+dotprod" \
            --verbose_failures

      - name: ğŸ“¦ [5] å°åŒ…
        if: success()
        run: |
          IMG=$(find kernel_workspace/out -name "Image" -type f | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp "$IMG" ./AnyKernel3/
          cd AnyKernel3 && zip -r9 ../Ultimate_OP_PadPro_Kernel.zip ./*

      - name: ğŸ“¤ [6] å‘å¸ƒ
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Ultimate-Kernel
          path: ./*.zip