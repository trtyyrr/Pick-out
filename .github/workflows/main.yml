name: OnePlus_PadPro_Official_Ultimate

on:
  workflow_dispatch:
    inputs:
      custom_command:
        description: 'ç¼–è¯‘æŒ‡ä»¤'
        required: true
        default: 'python3 kernel_platform/build_with_bazel.py -t pineapple gki'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æžè‡´ç£ç›˜æ¸…ç†
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: 2. æ£€å‡ºé…ç½®
        uses: actions/checkout@v4

      - name: 3. å®‰è£…å·¥å…·å¹¶åŒæ­¥å®˜æ–¹æºç 
        run: |
          # é…ç½® Git
          git config --global user.email "bot@github.com"
          git config --global user.name "KernelBot"
          
          # å®‰è£… Repo åˆ°å½“å‰ç›®å½•å¹¶åŠ å…¥ä¸´æ—¶è·¯å¾„
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH="$HOME/bin:$PATH"
          
          # å¼€å§‹åŒæ­¥
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/${{ github.repository }}.git -b main -m manifest.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync || repo sync -c -j1 --force-sync

      - name: 4. æ¿€æ´»å®˜æ–¹æºç éšè—ä¼˜åŒ– (BBRv3/MGLRU/1000Hz)
        run: |
          # å®šä½åˆ°å®˜æ–¹ GKI é…ç½®è·¯å¾„
          # æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ä½ çš„æ¸…å•å°† common æ”¾åœ¨äº† kernel_platform/common
          CONF_PATH="workspace/kernel_platform/common/arch/arm64/configs/gki_defconfig"
          
          if [ -f "$CONF_PATH" ]; then
            echo "ðŸš€ æ­£åœ¨å‘å®˜æ–¹é…ç½®æ³¨å…¥ä¼˜åŒ–..."
            cat >> "$CONF_PATH" <<EOF
          # ç½‘ç»œæ‰©å±•
          CONFIG_TCP_CONG_BBR=y
          CONFIG_TCP_CONG_BBRV3=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_NET_SCH_FQ_CODEL=y
          CONFIG_TCP_CONG_ADVANCED=y
          # å†…å­˜ç®¡ç†
          CONFIG_LRU_GEN=y
          CONFIG_LRU_GEN_ENABLED=y
          # æ€§èƒ½è°ƒåº¦
          CONFIG_HZ_1000=y
          CONFIG_SCHED_WALT=y
          EOF
            # ç¦ç”¨è°ƒè¯•ä»¥æå‡é€Ÿåº¦
            sed -i 's/CONFIG_DEBUG_KERNEL=y/CONFIG_DEBUG_KERNEL=n/' "$CONF_PATH"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° gki_defconfigï¼Œè¯·æ£€æŸ¥æ¸…å•è·¯å¾„"
            exit 1
          fi

      - name: 5. ç¼–è¯‘å‡†å¤‡ä¸Žèµ‹æƒ
        run: |
          cd workspace
          find kernel_platform -name "*.sh" -exec chmod +x {} +
          find kernel_platform -name "bazel" -exec chmod +x {} +
          [ -f kernel_platform/build_with_bazel.py ] && chmod +x kernel_platform/build_with_bazel.py

      - name: 6. æ‰§è¡Œå®˜æ–¹ Bazel ç¼–è¯‘
        run: |
          # ä¸´æ—¶åŠ å…¥ repo è·¯å¾„ä»¥é˜²ç¼–è¯‘è„šæœ¬éœ€è¦
          export PATH="$HOME/bin:$PATH"
          cd workspace
          ${{ github.event.inputs.custom_command }}

      - name: 7. è‡ªåŠ¨åŒ– AnyKernel3 æ‰“åŒ…
        if: success()
        run: |
          KERNEL_IMAGE=$(find workspace/out -name "Image.gz" | head -n 1)
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
          cp "$KERNEL_IMAGE" ak3/
          cd ak3
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/' anykernel.sh
          zip -r9 ../OnePlus_PadPro_Kernel_Official_BBR.zip *
          
      - name: 8. ä¸Šä¼ æˆå“
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Official_Optimized_Kernel
          path: "*.zip"

      - name: 9. å¤±è´¥è¯Šæ–­
        if: failure()
        run: |
          tar -czf debug_info.tar.gz --exclude='workspace/.repo' --exclude='workspace/out' workspace/kernel_platform
          
      - name: 10. ä¸Šä¼ è¯Šæ–­åŒ…
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Debug_Source
          path: debug_info.tar.gz