name: OnePlus_PadPro_Ultimate_Build_Force

on:
  workflow_dispatch:
    inputs:
      custom_command:
        description: 'ç¼–è¯‘æŒ‡ä»¤'
        required: true
        default: 'python3 kernel_platform/build_with_bazel.py -t pineapple gki'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: 2. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 3. å®‰è£…å·¥å…·å¹¶åŒæ­¥æºç 
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "KernelBot"
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH="$HOME/bin:$PATH"
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/${{ github.repository }}.git -b main -m manifest.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync || repo sync -c -j1 --force-sync

      - name: 4. æ³¨å…¥ä¼˜åŒ–å¹¶å¼ºåˆ¶å…³é—­æ ¡éªŒè„šæœ¬
        run: |
          CONF_PATH="workspace/kernel_platform/common/arch/arm64/configs/gki_defconfig"
          
          # 1. æ³¨å…¥ä¼˜åŒ–å‚æ•°
          if [ -f "$CONF_PATH" ]; then
            echo "ðŸš€ æ­£åœ¨æ³¨å…¥æžè‡´ä¼˜åŒ–é…ç½®..."
            sed -i '/CONFIG_TCP_CONG_BBR/d' "$CONF_PATH"
            sed -i '/CONFIG_NET_SCH_FQ/d' "$CONF_PATH"
            sed -i '/CONFIG_LRU_GEN/d' "$CONF_PATH"
            sed -i '/CONFIG_HZ_/d' "$CONF_PATH"
            sed -i '/CONFIG_SCHED_WALT/d' "$CONF_PATH"
            sed -i '/CONFIG_TCP_CONG_ADVANCED/d' "$CONF_PATH"
            sed -i '/CONFIG_DEBUG_KERNEL/d' "$CONF_PATH"
            
            cat >> "$CONF_PATH" <<EOF
CONFIG_TCP_CONG_ADVANCED=y
CONFIG_TCP_CONG_BBR=y
CONFIG_TCP_CONG_BBRV3=y
CONFIG_NET_SCH_FQ=y
CONFIG_NET_SCH_FQ_CODEL=y
CONFIG_LRU_GEN=y
CONFIG_LRU_GEN_ENABLED=y
CONFIG_HZ_1000=y
CONFIG_SCHED_WALT=y
CONFIG_DEBUG_KERNEL=n
EOF
          fi

          # 2. ã€ç‰©ç†å¤§æ‹›ã€‘ä¿®æ”¹ç¼–è¯‘ç³»ç»Ÿå†…éƒ¨é€»è¾‘ï¼Œå±è”½ savedefconfig æŠ¥é”™
          # å°†è„šæœ¬ä¸­çš„ fail() æ›¿æ¢ä¸º print()ï¼Œè®©æ ¡éªŒä¸åŒ¹é…æ—¶ä»…æ‰“å°ä¸ä¸­æ–­
          echo "ðŸ› ï¸ æ­£åœ¨ç ´è§£ Kleaf æ ¡éªŒé€»è¾‘..."
          find workspace/kernel_platform -name "defconfig.bzl" -exec sed -i 's/fail("savedefconfig does not match/print("âš ï¸ å¿½ç•¥å·®å¼‚: savedefconfig does not match/g' {} +
          
          # 3. å±è”½æŸäº›ç‰ˆæœ¬è„šæœ¬ä¸­çš„ exit 1 å¼ºåˆ¶é€€å‡º
          find workspace/kernel_platform -name "*.sh" -exec sed -i 's/exit 1/echo å¿½ç•¥é”™è¯¯/g' {} +

      - name: 5. è„šæœ¬èµ‹æƒ
        run: |
          cd workspace
          find kernel_platform -name "*.sh" -exec chmod +x {} +
          find kernel_platform -name "bazel" -exec chmod +x {} +
          [ -f kernel_platform/build_with_bazel.py ] && chmod +x kernel_platform/build_with_bazel.py

      - name: 6. è¿è¡Œç¼–è¯‘ (å¼ºåˆ¶é€šè¿‡æ¨¡å¼)
        run: |
          export PATH="$HOME/bin:$PATH"
          
          # è®¾ç½®å…¨å±€è·³è¿‡å¼€å…³
          export SKIP_ABI_CHECK=1
          export SKIP_IF_SAVEDEFCONFIG_DOES_NOT_MATCH=1
          export KBUILD_BUILD_USER=trtyyrr
          export KBUILD_BUILD_HOST=GitHubActions
          export ABIDW=false
          
          cd workspace
          # ä½¿ç”¨ -- ä¼ é€’é¢å¤–çš„ Bazel å‚æ•°æ¥è¿›ä¸€æ­¥åŽ‹åˆ¶æ ¡éªŒ
          ${{ github.event.inputs.custom_command }} -- \
            --action_env=SKIP_ABI_CHECK=1 \
            --action_env=SKIP_IF_SAVEDEFCONFIG_DOES_NOT_MATCH=1 \
            --define=ABIDW=false

      - name: 7. æ‰“åŒ…å†…æ ¸é•œåƒ
        if: success()
        run: |
          KERNEL_IMAGE=$(find workspace/out -name "Image.gz" | head -n 1)
          [ -z "$KERNEL_IMAGE" ] && KERNEL_IMAGE=$(find workspace/out -name "Image" | head -n 1)
          
          if [ -f "$KERNEL_IMAGE" ]; then
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
            cp "$KERNEL_IMAGE" ak3/
            cd ak3
            sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/' anykernel.sh
            zip -r9 ../OnePlus_PadPro_Ultimate.zip *
          else
            echo "âŒ ç¼–è¯‘å¯èƒ½æˆåŠŸä½†æœªæ‰¾åˆ°é•œåƒ"
            exit 1
          fi

      - name: 8. ä¸Šä¼ æˆå“
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Optimized_Kernel
          path: "*.zip"

      - name: 9. å¤±è´¥è¯Šæ–­ (ä»…ä¸Šä¼ æ ¸å¿ƒé…ç½®)
        if: failure()
        run: |
          tar -czf debug_info.tar.gz workspace/kernel_platform/common/arch/arm64/configs/gki_defconfig || true

      - name: 10. ä¸Šä¼ é”™è¯¯åŒ…
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Debug_Log
          path: debug_info.tar.gz