name: OnePlus Pad Pro Ultimate Kernel Build (Optimized)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 480

    steps:
      - name: ğŸš€ 1. æè‡´ç©ºé—´æ¸…ç†ä¸ 32GB è™šæ‹Ÿå†…å­˜æ‰©å®¹
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /usr/local/.ghcup /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /opt/az
          sudo apt-get clean
          sudo docker image prune -a -f
          sudo swapoff -a
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo sysctl vm.swappiness=100
          echo "âœ… ç£ç›˜ä¸è™šæ‹Ÿå†…å­˜å‡†å¤‡å°±ç»ª"

      - name: ğŸ“¥ 2. æ£€å‡ºæºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜¢ï¸ 3. æ³¨å…¥å…¨ç»´åº¦æè‡´ä¼˜åŒ– (å½±åƒ/å†…å­˜/æ€§èƒ½/è°ƒåº¦/ç½‘ç»œ/IO/VM/æ—¥å¿—)
        run: |
          cd common # è¿›å…¥å†…æ ¸æºç ä¸»ç›®å½•ï¼Œæ ¹æ®ä½ ä»“åº“ç»“æ„è°ƒæ•´
          echo "â˜¢ï¸ å¼€å§‹æ‰§è¡Œç‹‚æš´æ³¨å…¥..."

          # --- [1. è°ƒåº¦ä¸å“åº”] 1000Hzå¿ƒè·³ + å®Œå…¨æŠ¢å æ¨¡å¼ + WALT ---
          find . -name "Kconfig*" -exec sed -i 's/default 250/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/default 300/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/config PREEMPT_VOLUNTARY/config PREEMPT/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/bool "WALT scheduler"/bool "WALT scheduler"\n\tdefault y/' {} +

          # --- [2. å†…å­˜ä¿æ´»] MGLRU æ»¡è¡€å¼€å¯ + ZRAM å‹ç¼©ä¼˜åŒ– ---
          if [ -f "mm/Kconfig" ]; then
            sed -i '/config LR_GEN$/,/bool/s/bool "Multi-Gen LRU"/bool "Multi-Gen LRU"\n\tdefault y/' mm/Kconfig
            sed -i '/config LRU_GEN_ENABLED$/,/bool/s/bool "Enabled by default"/bool "Enabled by default"\n\tdefault y/' mm/Kconfig
          fi

          # --- [3. ç½‘ç»œåŠ é€Ÿ] BBRv3 + FQ-Codel ç®—æ³• ---
          sed -i 's/default "cubic"/default "bbrv3"/' net/ipv4/Kconfig
          # å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœbbrv3æ²¡åˆå…¥ï¼Œè‡³å°‘ç¡®ä¿ä½¿ç”¨bbr
          sed -i 's/default TCP_CONG_CUBIC/default TCP_CONG_BBRV3/' net/ipv4/Kconfig

          # --- [4. å½±åƒå¢å¼º] æå‡ç›¸æœº ISP ä¼˜å…ˆçº§ ---
          find drivers/media -name "Kconfig*" -exec sed -i 's/bool "Qualcomm Technologies, Inc. MSM Camera"/bool "Qualcomm Technologies, Inc. MSM Camera"\n\tdefault y/' {} +

          # --- [5. è¯»å†™åŠ é€Ÿ] BFQ é’ˆå¯¹ UFS 4.0 è°ƒä¼˜ ---
          find block -name "Kconfig*" -exec sed -i 's/default MQ_DEADLINE/default BFQ/g' {} +

          # --- [6. ç»­èˆªå‡è¡¡] æé€Ÿç¡çœ å“åº” + Schedutil ---
          if [ -f "kernel/power/Kconfig" ]; then
            sed -i 's/bool "Suspend to RAM and standby"/bool "Suspend to RAM and standby"\n\tdefault y/' kernel/power/Kconfig
          fi
          find drivers/cpufreq -name "Kconfig*" -exec sed -i 's/default CPU_FREQ_GOV_PERFORMANCE/default CPU_FREQ_GOV_SCHEDUTIL/g' {} +

          # --- [7. VM è°ƒä¼˜] è„æ•°æ®å›å†™ä¼˜åŒ– ---
          [ -f "kernel/sysctl.c" ] && sed -i 's/dirty_background_ratio = 10/dirty_background_ratio = 5/g' kernel/sysctl.c

          # --- [8. æè‡´ç¼–è¯‘] å¼ºåˆ¶ O3 çº§åˆ«æŒ‡ä»¤é‡æ’ + æ—¥å¿—é™å™ª ---
          sed -i 's/-O2/-O3/g' Makefile
          find . -name "Kconfig.debug" -exec sed -i 's/default y/default n/g' {} +

          # --- [æš´åŠ›é˜‰å‰² Kleaf æ ¡éªŒé€»è¾‘é—¨] ---
          cd ..
          echo "ğŸ”¨ æ­£åœ¨æ‘§æ¯ Kleaf æ ¡éªŒé˜²å¾¡..."
          find build/kernel/kleaf -name "*.bzl" -exec sed -i 's/fail(/print(/g' {} +
          find build/kernel/kleaf -name "*.sh" -exec sed -i 's/exit 1/exit 0/g' {} +
          find build/kernel/kleaf -name "kernel_config.bzl" -exec sed -i 's/if diff_ret != 0:/if False:/g' {} +
          echo "âœ… ä¼˜åŒ–æ³¨å…¥å®Œæˆ"

      - name: ğŸ”¨ 4. æ‰§è¡Œç¼–è¯‘ (è·¯å¾„ä¿®å¤ + å†…å­˜é™åˆ¶)
        run: |
          # ä½¿ç”¨ ./tools/bazel å¹¶é…åˆå†…å­˜/CPUé™åˆ¶
          ./tools/bazel build //msm-kernel:pineapple_gki \
            --jobs=2 \
            --local_ram_resources=6144 \
            --local_cpu_resources=2 \
            --define=LTO=full \
            --copt="-O3" \
            --copt="-mcpu=cortex-x4" \
            --verbose_failures

      - name: ğŸ“¦ 5. å°åŒ… AnyKernel3
        if: success()
        run: |
          IMAGE_PATH=$(find out -name "Image" -type f | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp "$IMAGE_PATH" ./AnyKernel3/
          cd AnyKernel3 && zip -r9 ../OnePlus_PadPro_Ultimate.zip ./*

      - name: ğŸ“¤ 6. ä¸Šä¼ å†…æ ¸
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Ultimate-Kernel
          path: ./*.zip