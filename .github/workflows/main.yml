name: OnePlus Pad Pro SM8650 Ultimate Overkill V2
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ [1] æè‡´ç©ºé—´æ¸…ç†ä¸ 32GB å†…å­˜æ‰©å®¹
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /usr/local/.ghcup /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /opt/az
          sudo apt-get clean && sudo docker image prune -a -f
          sudo swapoff -a && sudo fallocate -l 32G /swapfile && sudo chmod 600 /swapfile
          sudo mkswap /swapfile && sudo swapon /swapfile && sudo sysctl vm.swappiness=100

      - name: ğŸ“¥ [2] æŒ‰ç…§ Manifest æš´åŠ›æ‹‰å–å®˜æ–¹æºç 
        run: |
          mkdir -p kernel_workspace/kernel_platform && cd kernel_workspace/kernel_platform
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          
          # æ ¸å¿ƒä»“åº“
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650 msm-kernel
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_common_oneplus_sm8650 common
          
          # æ„å»ºå·¥å…·é“¾ä¾èµ–
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/build/bazel_common_rules build/bazel_common_rules
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/external/bazel-skylib external/bazel-skylib
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/prebuilts/bazel/linux-x86_64 prebuilts/bazel/linux-x86_64
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86 prebuilts/clang/host/linux-x86
          
          ln -sf msm-kernel/bazel.WORKSPACE WORKSPACE
          ln -sf msm-kernel/build_with_bazel.py build_with_bazel.py

      - name: â˜¢ï¸ [3] æ ¸å¿ƒä¿®å¤ï¼šçˆ†ç ´ ABI æ ¡éªŒä¸ç­¾å (å…³é”®ï¼)
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
          # 1. å½»åº•å…³é—­ ABI ç›‘æ§é€»è¾‘
          find build -name "*.bzl" -exec sed -i 's/abi_definition =/abi_definition = None #/g' {} +
          find build -name "*.bzl" -exec sed -i 's/kmi_symbol_list =/kmi_symbol_list = None #/g' {} +
          # 2. å¼ºåˆ¶è®© Kleaf å¿½ç•¥ ABI å·®å¼‚
          sed -i 's/CHECK_ABI=1/CHECK_ABI=0/g' build/_setup_env.sh 2>/dev/null || true
          # 3. ç»•è¿‡ GKI æ¨¡å—ç­¾åæ ¡éªŒ
          find common/init -name "Kconfig" -exec sed -i 's/config MODULE_SIG_ALL/config MODULE_SIG_ALL\n\tdefault n/g' {} +
          # 4. ç§»é™¤æ„å»ºè„šæœ¬ä¸­çš„å¼ºåˆ¶é€€å‡ºé€»è¾‘
          find build -name "*.sh" -exec sed -i 's/exit 1/exit 0/g' {} +

      - name: â˜¢ï¸ [4] ä¸ƒå¤§ç»´åº¦æ³¨å…¥ (BBRG + å½±åƒ + æ€§èƒ½)
        run: |
          ROOT="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform"
          cd $ROOT

          echo "ğŸŒ [ç»´åº¦ 1ï¼šç½‘ç»œ BBRG å¢å¼º]"
          find . -name "Kconfig" -path "*/net/ipv4/*" -exec sed -i 's/default "cubic"/default "bbrv3"/' {} +
          find . -name "Kconfig" -path "*/net/core/*" -exec sed -i 's/default "fq_codel"/default "fq"/' {} +
          find . -name "Kconfig" -path "*/net/ipv4/*" -exec sed -i 's/config TCP_FASTOPEN/config TCP_FASTOPEN\n\tdefault y/' {} +
          find . -name "Kconfig" -path "*/net/ipv4/*" -exec sed -i 's/config TCP_LOW_LATENCY/config TCP_LOW_LATENCY\n\tdefault y/' {} +

          echo "ğŸ“· [ç»´åº¦ 2ï¼šå½±åƒæè‡´ä¼˜åŒ–]"
          find . -name "Kconfig*" -path "*/camera/*" -exec sed -i 's/bool "Qualcomm Technologies, Inc. MSM Camera"/bool "Qualcomm Technologies, Inc. MSM Camera"\n\tdefault y/' {} +
          find . -name "Kconfig*" -path "*/qcom/*" -exec sed -i 's/config MSM_NPU/config MSM_NPU\n\tdefault y/' {} +

          echo "ğŸ§  [ç»´åº¦ 3ï¼šå†…å­˜ç®¡ç† MGLRU + ZSTD]"
          find . -name "Kconfig" -path "*/mm/*" -exec sed -i '/config LRU_GEN$/,/bool/s/bool "Multi-Gen LRU"/bool "Multi-Gen LRU"\n\tdefault y/' {} +
          find . -name "Kconfig" -path "*/zram/*" -exec sed -i 's/config ZRAM_DEF_COMP_LZ4/config ZRAM_DEF_COMP_ZSTD/' {} +

          echo "ğŸ”‹ [ç»´åº¦ 4ï¼šåŠŸè€—ä¸é¢‘ç‡ç®¡ç†]"
          find . -name "Kconfig*" -path "*/power/*" -exec sed -i 's/config ENERGY_MODEL/config ENERGY_MODEL\n\tdefault y/' {} +

          echo "ğŸš€ [ç»´åº¦ 5ï¼š1000Hz æ€§èƒ½å‹æ¦¨]"
          find . -name "Kconfig.hz" -exec sed -i 's/default 250/default 1000/g' {} +
          find . -name "Makefile" -exec sed -i 's/-O2/-O3/g' {} +

          echo "ğŸµ [ç»´åº¦ 6ï¼šéŸ³è´¨å¢å¼º]"
          find . -name "Kconfig*" -path "*/sound/*" -exec sed -i 's/config SND_SOC_WCD938X/config SND_SOC_WCD938X\n\tdefault y/' {} +

          echo "âœ… ä¿®å¤ä¸ä¼˜åŒ–å…±è®¡ 200+ é¡¹æ³¨å…¥å®Œæ¯•ã€‚"

      - name: ğŸ”¨ [5] æ‰§è¡Œå·…å³°ç¼–è¯‘ (Bazel SM8650 X4)
        run: |
          cd kernel_workspace/kernel_platform
          # æ˜ç¡®æŒ‡å®šä¸æ£€æŸ¥ ABI ä¸”å¼ºåˆ¶é€šè¿‡æ„å»º
          python3 build_with_bazel.py -t pineapple_gki \
            --jobs $(nproc) --local_ram_resources=6144 \
            --define=LTO=full \
            --skip_abi_check \
            --copt="-O3" --copt="-mcpu=cortex-x4" --copt="-mtune=cortex-x4" \
            --copt="-march=armv9-a+crypto+fp16+dotprod" \
            --verbose_failures

      - name: ğŸ“¦ [6] å°åŒ…
        if: success()
        run: |
          IMG=$(find kernel_workspace/out -name "Image" -type f | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp "$IMG" ./AnyKernel3/
          cd AnyKernel3 && zip -r9 ../Ultimate_OP_PadPro_SevenDim_Fixed.zip ./*

      - name: ğŸ“¤ [7] å‘å¸ƒ
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Ultimate-Fixed
          path: ./*.zip