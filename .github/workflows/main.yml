name: OnePlus Pad Pro SM8650 Seven-Dim Insane Overkill
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ [1] æè‡´æ¸…ç†ä¸ç£ç›˜è„±æ°´
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /usr/local/.ghcup /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /opt/az
          sudo apt-get clean && sudo docker image prune -a -f
          sudo swapoff -a && sudo fallocate -l 32G /swapfile && sudo chmod 600 /swapfile
          sudo mkswap /swapfile && sudo swapon /swapfile && sudo sysctl vm.swappiness=100

      - name: ğŸ“¥ [2] æŒ‰ç…§ Manifest æš´åŠ›æ‹‰å–å®˜æ–¹æºç 
        run: |
          mkdir -p kernel_workspace/kernel_platform && cd kernel_workspace/kernel_platform
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650 msm-kernel
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_common_oneplus_sm8650 common
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/build/bazel_common_rules build/bazel_common_rules
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/prebuilts/bazel/linux-x86_64 prebuilts/bazel/linux-x86_64
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86 prebuilts/clang/host/linux-x86
          ln -sf msm-kernel/bazel.WORKSPACE WORKSPACE
          ln -sf msm-kernel/build_with_bazel.py build_with_bazel.py

      - name: â˜¢ï¸ [3] ABI çˆ†ç ´ä¸ç¯å¢ƒä¿®å¤ (å‰ç½®å‡†å¤‡)
        run: |
          cd kernel_workspace/kernel_platform
          find build -name "*.bzl" -exec sed -i 's/abi_definition =/abi_definition = None #/g' {} +
          find build -name "*.bzl" -exec sed -i 's/kmi_symbol_list =/kmi_symbol_list = None #/g' {} +
          echo "DANGEROUS_SKIP_ABI_CHECK=true" >> $GITHUB_ENV

      - name: â˜¢ï¸ [4] ä¸ƒå¤§ç»´åº¦â€œç‹‚æš´â€ä»£ç æ³¨å…¥ (æ‰‹åŠ¨å±•å¼€ï¼Œç»ä¸ç¼©å‡)
        run: |
          cd kernel_workspace/kernel_platform
          
          # å®šä¹‰éœ€è¦çˆ†ç ´çš„ç›®æ ‡é…ç½®æ–‡ä»¶ (Defconfigs)
          GKI_CONFIG="common/arch/arm64/configs/gki_defconfig"
          VENDOR_CONFIG="msm-kernel/arch/arm64/configs/vendor/pineapple_GKI.config"

          echo "ğŸŒ [1. ç½‘ç»œ BBRG]ï¼šæ³¨å…¥ BBRv3 + FQ + TFO"
          for cfg in $GKI_CONFIG $VENDOR_CONFIG; do
            [ -f "$cfg" ] || continue
            echo "CONFIG_TCP_CONG_BBR=y" >> $cfg
            echo "CONFIG_TCP_CONG_BBRV3=y" >> $cfg
            echo "CONFIG_DEFAULT_TCP_CONG=\"bbrv3\"" >> $cfg
            echo "CONFIG_NET_SCH_FQ=y" >> $cfg
            echo "CONFIG_DEFAULT_NET_SCH=\"fq\"" >> $cfg
            echo "CONFIG_TCP_FASTOPEN=y" >> $cfg
            echo "CONFIG_TCP_LOW_LATENCY=y" >> $cfg
          done

          echo "ğŸ“· [2. å½±åƒ]ï¼šISP å“åº”ä¸ NPU æš´åŠ›åŠ é€Ÿ"
          for cfg in $VENDOR_CONFIG; do
            echo "CONFIG_MSM_CAMERA=y" >> $cfg
            echo "CONFIG_MSM_NPU=y" >> $cfg
            echo "CONFIG_MSM_NPU_DEBUG_LEVEL=0" >> $cfg
            echo "CONFIG_COMMON_CLK_QCOM=y" >> $cfg
          done

          echo "ğŸ§  [3. å†…å­˜]ï¼šMGLRU æ»¡è¡€ + ZSTD + VM å‹æ¦¨"
          for cfg in $GKI_CONFIG; do
            echo "CONFIG_LRU_GEN=y" >> $cfg
            echo "CONFIG_LRU_GEN_ENABLED=y" >> $cfg
            echo "CONFIG_ZRAM_DEF_COMP_ZSTD=y" >> $cfg
          done
          # ç‰©ç†çˆ†ç ´ VM å›æ”¶é€»è¾‘
          sed -i 's/dirty_background_ratio = 10/dirty_background_ratio = 5/g' common/kernel/sysctl.c
          sed -i 's/dirty_ratio = 20/dirty_ratio = 10/g' common/kernel/sysctl.c

          echo "ğŸ”‹ [4. åŠŸè€—]ï¼šèƒ½é‡æ¨¡å‹ä¸ TEO è°ƒé€Ÿå™¨"
          echo "CONFIG_ENERGY_MODEL=y" >> $GKI_CONFIG
          echo "CONFIG_CPU_IDLE_GOV_TEO=y" >> $GKI_CONFIG

          echo "ğŸš€ [5. æ€§èƒ½]ï¼š1000Hz + å®Œå…¨æŠ¢å  + X4 æ¶æ„å‹æ¦¨"
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' $GKI_CONFIG
          sed -i 's/CONFIG_HZ_250=y/CONFIG_HZ_1000=y/g' $GKI_CONFIG
          echo "CONFIG_PREEMPT=y" >> $GKI_CONFIG
          # å¼ºåˆ¶ Makefile ä½¿ç”¨ O3 
          find . -name "Makefile" -exec sed -i 's/-O2/-O3/g' {} +

          echo "ğŸµ [6. éŸ³è´¨]ï¼šWCD938X ä½å»¶è¿Ÿæ¨¡å¼"
          echo "CONFIG_SND_SOC_WCD938X=y" >> $VENDOR_CONFIG
          echo "CONFIG_SND_SOC_WCD938X_MBHC=y" >> $VENDOR_CONFIG

          echo "ğŸ”‡ [7. é™å™ª]ï¼šå½»åº•å…³é—­è°ƒè¯•æ—¥å¿—æŸè€—"
          echo "CONFIG_SLUB_DEBUG=n" >> $GKI_CONFIG
          echo "CONFIG_PANIC_ON_OOPS=n" >> $GKI_CONFIG
          echo "CONFIG_DEBUG_KERNEL=n" >> $GKI_CONFIG
          sed -i 's/console_loglevel = 7/console_loglevel = 3/g' common/kernel/printk/printk.c

      - name: ğŸ”¨ [5] æ‰§è¡Œå·…å³°ç¼–è¯‘ (Bazel SM8650 X4)
        run: |
          cd kernel_workspace/kernel_platform
          python3 build_with_bazel.py -t pineapple_gki \
            --jobs $(nproc) --local_ram_resources=6144 \
            --define=LTO=full \
            --skip_abi_check \
            --copt="-O3" --copt="-mcpu=cortex-x4" --copt="-mtune=cortex-x4" \
            --copt="-march=armv9-a+crypto+fp16+dotprod"

      - name: ğŸ“¦ [6] å°åŒ…
        run: |
          IMG=$(find kernel_workspace/out -name "Image" -type f | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp "$IMG" ./AnyKernel3/
          cd AnyKernel3 && zip -r9 ../Ultimate_OP_PadPro_RealInsane.zip ./*

      - name: ğŸ“¤ [7] å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Real-Ultimate
          path: ./*.zip