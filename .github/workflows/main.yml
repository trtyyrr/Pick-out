name: OnePlus_PadPro_Ultimate_Full_Power_Clang20

on:
  workflow_dispatch:
    inputs:
      custom_command:
        description: 'ç¼–è¯‘æŒ‡ä»¤'
        required: true
        default: "python3 kernel_platform/build_with_bazel.py -t pineapple gki"

jobs:
  build:
    runs-on: ubuntu-latest # æˆ–è€…ä½ ä½¿ç”¨çš„å…¶ä»– runner

    steps:
      - name: ğŸš€ æè‡´ç£ç›˜æ¸…ç†ä¸ 32GB è™šæ‹Ÿå†…å­˜æ‰©å®¹
        run: |
          echo "========= æ¸…ç†å‰ç£ç›˜çŠ¶æ€ ========="
          df -h
          
          # 1. æš´åŠ›åˆ é™¤ GitHub é¢„è£…çš„å·¨å‹è½¯ä»¶åŒ… (é‡Šæ”¾çº¦ 35GB-40GB)
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /opt/az
          
          # 2. æ¸…ç†ç³»ç»Ÿå†—ä½™
          sudo apt-get clean
          sudo docker image prune -a -f
          
          # 3. åˆ›å»º 32GB Swapfile (è¿™æ˜¯è¿‡ LTO é“¾æ¥çš„å…³é”®)
          sudo swapoff -a
          sudo fallocate -l 32G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # 4. ä¼˜åŒ–å†…æ ¸äº¤æ¢å‚æ•°
          sudo sysctl vm.swappiness=100
          
          echo "========= æ¸…ç†åç£ç›˜ä¸å†…å­˜çŠ¶æ€ ========="
          free -h
          df -h

      # ... (è¿™é‡Œæ˜¯ä½ ä¹‹å‰çš„ä»£ç ï¼Œå¦‚ Checkout ä»£ç ã€é…ç½®ç¯å¢ƒç­‰)

      - name: ğŸ”¨ é™åˆ¶å¹¶å‘ç¼–è¯‘ (é˜² OOM å…³é”®æ­¥)
        run: |
          # åœ¨æ‰§è¡Œ bazel build æ—¶ï¼Œå¿…é¡»åŠ å…¥å†…å­˜å’Œæ ¸å¿ƒé™åˆ¶å‚æ•°
          # å³ä½¿æœ‰ Swapï¼Œä¹Ÿè¦é˜²æ­¢ç¬é—´å¹¶å‘è¿‡é«˜å¯¼è‡´ Kernel Panic
          
          bazel build //msm-kernel:pineapple_gki \
            --local_ram_resources=6144 \
            --local_cpu_resources=2 \
            --jobs=2 \
            --define=LTO=full \
            --verbose_failures
      - name: 2. åŒæ­¥æºç ä¸å®‰è£…å·¥å…·é“¾
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "KernelBot"
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH="$HOME/bin:$PATH"
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/${{ github.repository }}.git -b main -m manifest.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync
          
          # å®‰è£… LLVM/Clang 20 (åŒæ­¥ä½ æœ‹å‹çš„æˆåŠŸç¯å¢ƒ)
          sudo apt-get update && sudo apt-get install -y clang-20 lld-20 llvm-20

      - name: 3. å…¨ç»´åº¦ä¼˜åŒ–æ³¨å…¥ä¸ Bazel ç‰©ç†å¯¹é½
        run: |
          cd workspace/kernel_platform/common
          echo "â˜¢ï¸ æ­£åœ¨æ³¨å…¥å…¨ç»´åº¦æè‡´ä¼˜åŒ– (å½±åƒ/å†…å­˜/æ€§èƒ½/è°ƒåº¦/ç½‘ç»œ/IO/VM/æ—¥å¿—)..."

          # --- [1. è°ƒåº¦ä¸å“åº”] 1000Hzå¿ƒè·³ + å®Œå…¨æŠ¢å æ¨¡å¼ + WALT ---
          find . -name "Kconfig*" -exec sed -i 's/default 250/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/default 300/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/config PREEMPT_VOLUNTARY/config PREEMPT/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/bool "WALT scheduler"/bool "WALT scheduler"\n\tdefault y/' {} +

          # --- [2. å†…å­˜ä¿æ´»] MGLRU æ»¡è¡€å¼€å¯ + ZRAM å‹ç¼©ä¼˜åŒ– ---
          if [ -f "mm/Kconfig" ]; then
            sed -i '/config LRU_GEN$/,/bool/s/bool "Multi-Gen LRU"/bool "Multi-Gen LRU"\n\tdefault y/' mm/Kconfig
            sed -i '/config LRU_GEN_ENABLED$/,/bool/s/bool "Enabled by default"/bool "Enabled by default"\n\tdefault y/' mm/Kconfig
          fi

          # --- [3. ç½‘ç»œåŠ é€Ÿ] BBRv3 + FQ-Codel ç®—æ³• ---
          sed -i 's/default "cubic"/default "bbrv3"/' net/ipv4/Kconfig
          sed -i 's/default TCP_CONG_CUBIC/default TCP_CONG_BBRV3/' net/ipv4/Kconfig

          # --- [4. å½±åƒå¢å¼º] å¼ºåˆ¶å¼€å¯å¹¶æå‡ç›¸æœº ISP ä¼˜å…ˆçº§ ---
          find drivers/media -name "Kconfig*" -exec sed -i 's/bool "Qualcomm Technologies, Inc. MSM Camera"/bool "Qualcomm Technologies, Inc. MSM Camera"\n\tdefault y/' {} +

          # --- [5. è¯»å†™åŠ é€Ÿ] I/O è°ƒåº¦å™¨ BFQ é’ˆå¯¹ UFS 4.0 è°ƒä¼˜ ---
          find block -name "Kconfig*" -exec sed -i 's/default MQ_DEADLINE/default BFQ/g' {} +

          # --- [6. ç»­èˆªå‡è¡¡] æé€Ÿç¡çœ å“åº” + Schedutil å‡è¡¡ ---
          if [ -f "kernel/power/Kconfig" ]; then
            sed -i 's/bool "Suspend to RAM and standby"/bool "Suspend to RAM and standby"\n\tdefault y/' kernel/power/Kconfig
          fi
          find drivers/cpufreq -name "Kconfig*" -exec sed -i 's/default CPU_FREQ_GOV_PERFORMANCE/default CPU_FREQ_GOV_SCHEDUTIL/g' {} +

          # --- [7. VM è°ƒä¼˜] è„æ•°æ®å›å†™ä¼˜åŒ– (å‡ç¼“ Jank) ---
          [ -f "kernel/sysctl.c" ] && sed -i 's/dirty_background_ratio = 10/dirty_background_ratio = 5/g' kernel/sysctl.c

          # --- [8. æè‡´ç¼–è¯‘] å¼ºåˆ¶ O3 çº§åˆ«æŒ‡ä»¤é‡æ’ + æ—¥å¿—é™å™ª ---
          sed -i 's/-O2/-O3/g' Makefile
          find . -name "Kconfig.debug" -exec sed -i 's/default y/default n/g' {} +

          # --- [æ ¸å¿ƒå¯¹é½é€»è¾‘] ç‰©ç†å¯¹é½ defconfig ä»¥ç»•è¿‡ Bazel æ ¡éªŒ ---
          echo "ğŸ”„ æ­£åœ¨é‡æ–°åŒæ­¥ defconfig æ–‡ä»¶ä»¥åŒ¹é…æ ¡éªŒé€»è¾‘..."
          make ARCH=arm64 O=out_tmp gki_defconfig
          make ARCH=arm64 O=out_tmp savedefconfig
          cp out_tmp/defconfig arch/arm64/configs/gki_defconfig
          rm -rf out_tmp

          # --- [æš´åŠ›åŒä¿é™©] å½»åº•é˜‰å‰² Kleaf æ ¡éªŒé€»è¾‘é—¨ ---
          cd ..
          find build/kernel/kleaf -name "*.bzl" -exec sed -i 's/fail(/print(/g' {} +
          find build/kernel/kleaf -name "*.sh" -exec sed -i 's/exit 1/exit 0/g' {} +
          find build/kernel/kleaf -name "kernel_config.bzl" -exec sed -i 's/if diff_ret != 0:/if False:/g' {} +

      - name: 4. æ‰§è¡Œå…¨é‡ç¼–è¯‘ (Clang 20 ç©¿é€)
        run: |
          # å¼ºåˆ¶å°† Clang 20 æ³¨å…¥ç³»ç»Ÿè·¯å¾„
          export PATH="/usr/lib/llvm-20/bin:$HOME/bin:$PATH"
          export SKIP_ABI_CHECK=1
          export SKIP_IF_SAVEDEFCONFIG_DOES_NOT_MATCH=1
          export ABIDW=false
          
          cd workspace
          ${{ github.event.inputs.custom_command }}

      - name: 5. æŒ–æ˜äº§ç‰©å¹¶æ‰“åŒ…
        if: always()
        run: |
          cd workspace
          # åœ¨ pineapple æ¶æ„è·¯å¾„ä¸‹æ·±åº¦æœç´¢ Image
          IMAGE_PATH=$(find kernel_platform/out -name "Image" -o -name "Image.gz" | grep "pineapple" | head -n 1)
          if [ -n "$IMAGE_PATH" ]; then
            ABS_IMAGE=$(realpath "$IMAGE_PATH")
            cd ..
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
            cp "$ABS_IMAGE" ak3/Image
            cd ak3
            sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/' anykernel.sh
            zip -r9 ../OnePlus_PadPro_Ultimate_AllInOne.zip *
          else
            echo "âŒ é•œåƒç”Ÿæˆå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ Step 4 ç»“å°¾çš„æŠ¥é”™"
            exit 1
          fi

      - name: 6. ä¸Šä¼ 
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Full_Ultimate_Kernel
          path: "*.zip"