name: OnePlus_PadPro_Full_Ultimate_Final

on:
  workflow_dispatch:
    inputs:
      custom_command:
        description: 'ç¼–è¯‘æŒ‡ä»¤'
        required: true
        default: 'python3 kernel_platform/build_with_bazel.py -t pineapple gki'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æè‡´ç£ç›˜æ¸…ç†
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: 2. æ£€å‡ºä¸åŒæ­¥æºç 
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "KernelBot"
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH="$HOME/bin:$PATH"
          mkdir -p workspace && cd workspace
          # ä½¿ç”¨ --depth=1 æé«˜åŒæ­¥é€Ÿåº¦
          repo init -u https://github.com/${{ github.repository }}.git -b main -m manifest.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync

      - name: 3. å…¨ç»´åº¦åº•å±‚æ³¨å…¥ (ç»•è¿‡æ ¡éªŒç‰ˆ)
        run: |
          cd workspace/kernel_platform/common
          echo "ğŸš€ å¯åŠ¨åº•å±‚ç¡¬ç¼–ç æ³¨å…¥ï¼Œä¸è§¦åŠ¨ defconfig æ–‡ä»¶..."

          # 1. å¼ºåˆ¶ BBRv3 ä¸ºé»˜è®¤ (ä¿®æ”¹ net å±‚çš„ Kconfig)
          if [ -f "net/ipv4/Kconfig" ]; then
            sed -i 's/default "cubic"/default "bbrv3"/' net/ipv4/Kconfig
            sed -i 's/default TCP_CONG_CUBIC/default TCP_CONG_BBRV3/' net/ipv4/Kconfig
          fi

          # 2. å¼ºåˆ¶ MGLRU é»˜è®¤å¼€å¯ (ä¿®æ”¹ mm å±‚çš„ Kconfig)
          if [ -f "mm/Kconfig" ]; then
            # æ‰¾åˆ° LRU_GEN çš„å®šä¹‰ï¼Œå¼ºåˆ¶è®¾ä¸º default y
            sed -i '/config LRU_GEN$/,/bool/s/bool "Multi-Gen LRU"/bool "Multi-Gen LRU"\n\tdefault y/' mm/Kconfig
            sed -i '/config LRU_GEN_ENABLED$/,/bool/s/bool "Enabled by default"/bool "Enabled by default"\n\tdefault y/' mm/Kconfig
          fi

          # 3. å¼ºåˆ¶ 1000Hz å“åº” (å…¨å±€æœç´¢ Kconfig)
          find . -name "Kconfig*" -exec sed -i 's/default 250/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/default 300/default 1000/g' {} +

          # 4. æš´åŠ›å±è”½ Bazel çš„æ ¡éªŒæŠ¥é”™å‡½æ•°
          # è¿™ä¸€æ­¥æ˜¯å…³é”®ï¼šç›´æ¥åˆ æ‰æˆ–æ³¨é‡Šæ‰æ ¡éªŒé€»è¾‘
          echo "ğŸ› ï¸ æ­£åœ¨ç‰©ç†å±è”½ Kleaf æ ¡éªŒ..."
          find ../build/kernel/kleaf -name "*.bzl" -exec sed -i 's/fail("savedefconfig does not match/print("âš ï¸ å¿½ç•¥å·®å¼‚: savedefconfig does not match/g' {} +
          
          # é¢å¤–ä¿é™©ï¼šè¿˜åŸ gki_defconfig åˆ°åŸå§‹çŠ¶æ€ï¼Œé˜²æ­¢å®ƒæŠ¥é”™
          git checkout arch/arm64/configs/gki_defconfig || true

      - name: 4. æ‰§è¡Œç¼–è¯‘ (çº¯å‡€ç¯å¢ƒå˜é‡æ¨¡å¼)
        run: |
          export PATH="$HOME/bin:$PATH"
          # æ³¨å…¥è·³è¿‡æ ¡éªŒçš„ç¯å¢ƒå˜é‡ï¼Œä¸å†åœ¨å‘½ä»¤è¡ŒåŠ å‚æ•°é¿å¼€è§£æé”™è¯¯
          export SKIP_ABI_CHECK=1
          export SKIP_IF_SAVEDEFCONFIG_DOES_NOT_MATCH=1
          export ABIDW=false
          export KBUILD_BUILD_USER=trtyyrr
          export KBUILD_BUILD_HOST=GitHubActions
          
          cd workspace
          python3 kernel_platform/build_with_bazel.py -t pineapple gki

      - name: 5. æš´åŠ›æŒ–æ˜é•œåƒå¹¶æ‰“åŒ…
        if: always()
        run: |
          echo "ğŸ” æ­£åœ¨åœ°æ¯¯å¼æœç´¢ç¼–è¯‘äº§ç‰©..."
          cd workspace
          # å¯»æ‰¾ç”Ÿæˆçš„äºŒè¿›åˆ¶ Image
          IMAGE_PATH=$(find kernel_platform -name "Image" -o -name "Image.gz" | grep "pineapple" | head -n 1)
          
          if [ -n "$IMAGE_PATH" ]; then
            echo "âœ… æˆåŠŸæŒ–æ˜åˆ°é•œåƒ: $IMAGE_PATH"
            ABS_IMAGE=$(realpath "$IMAGE_PATH")
            cd ..
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
            cp "$ABS_IMAGE" ak3/Image
            cd ak3
            sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/' anykernel.sh
            zip -r9 ../OnePlus_PadPro_Ultimate.zip *
          else
            echo "âŒ æœªèƒ½æŠ“å–åˆ°ç¼–è¯‘äº§ç‰©"
            exit 1
          fi

      - name: 6. ä¸Šä¼ æœ€ç»ˆå†…æ ¸åŒ…
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Full_Ultimate_Kernel
          path: "*.zip"