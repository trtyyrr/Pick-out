name: OnePlus Pad Pro SM8650 Ultimate Build
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 600

    steps:
      - name: ğŸš€ [1] ç¯å¢ƒæ¸…ç†ä¸ 32GB è™šæ‹Ÿå†…å­˜ (æé™æ‰©å®¹)
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /usr/local/.ghcup /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /opt/az
          sudo apt-get clean && sudo docker image prune -a -f
          sudo swapoff -a && sudo fallocate -l 32G /swapfile && sudo chmod 600 /swapfile
          sudo mkswap /swapfile && sudo swapon /swapfile && sudo sysctl vm.swappiness=100

      - name: ğŸ› ï¸ [2] å®‰è£… Repo ä¸é«˜çº§æ„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y binutils-dev libncurses5-dev build-essential bc bison flex libssl-dev libelf-dev python3 python-is-python3 git curl zip
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: ğŸ“¥ [3] åŒæ­¥æºç  (è®¤è¯ä¿®å¤ç‰ˆ)
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git config --global url."https://${{ github.token }}@github.com/".insteadOf "https://github.com/"
          
          echo "æ­£åœ¨åˆå§‹åŒ– SM8650 å®˜æ–¹æ¸…å•..."
          repo init -u https://github.com/OnePlusOSS/android_kernel_manifest_oneplus_sm8650.git -b oneplus/sm8650_v_15.0.0_pad_pro
          
          echo "æ­£åœ¨åŒæ­¥æºç  (çº¦ 20GB+)..."
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync

      - name: â˜¢ï¸ [4] æ³¨å…¥â€œå…¨ç»´åº¦ç‹‚æš´ä¼˜åŒ–â€ (ä¸ç¼©å‡ã€ä¸åˆå¹¶ã€æè‡´åŠ å¤š)
        run: |
          # å®šä¹‰å·¥ä½œè·¯å¾„
          COMMON_DIR="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/common"
          MSM_DIR="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/msm-kernel"
          
          echo "â˜¢ï¸ å¯åŠ¨æ ¸å¿ƒä¼˜åŒ–æ³¨å…¥..."

          # --- [ç»´åº¦ 1ï¼šå“åº”é€Ÿåº¦ä¸è°ƒåº¦] ---
          cd $COMMON_DIR
          find . -name "Kconfig*" -exec sed -i 's/default 250/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/default 300/default 1000/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/config PREEMPT_VOLUNTARY/config PREEMPT/g' {} +
          find . -name "Kconfig*" -exec sed -i 's/bool "WALT scheduler"/bool "WALT scheduler"\n\tdefault y/' {} +
          # é¢å¤–ï¼šå¼ºåˆ¶é«˜ç²¾åº¦å®šæ—¶å™¨
          find . -name "Kconfig*" -exec sed -i 's/bool "High Resolution Timer Support"/bool "High Resolution Timer Support"\n\tdefault y/' {} +

          # --- [ç»´åº¦ 2ï¼šå†…å­˜ä¿æ´»é»‘ç§‘æŠ€] ---
          if [ -f "mm/Kconfig" ]; then
            sed -i '/config LRU_GEN$/,/bool/s/bool "Multi-Gen LRU"/bool "Multi-Gen LRU"\n\tdefault y/' mm/Kconfig
            sed -i '/config LRU_GEN_ENABLED$/,/bool/s/bool "Enabled by default"/bool "Enabled by default"\n\tdefault y/' mm/Kconfig
          fi
          # é¢å¤–ï¼šå¤§å¹…åº¦ä¼˜åŒ– VM è„æ•°æ®åŒæ­¥é¢‘ç‡
          [ -f "kernel/sysctl.c" ] && sed -i 's/dirty_background_ratio = 10/dirty_background_ratio = 5/g' kernel/sysctl.c
          [ -f "kernel/sysctl.c" ] && sed -i 's/dirty_ratio = 20/dirty_ratio = 10/g' kernel/sysctl.c
          find . -name "Kconfig*" -exec sed -i 's/config ZRAM_DEF_COMP_LZ4/config ZRAM_DEF_COMP_ZSTD/' {} +

          # --- [ç»´åº¦ 3ï¼šç½‘ç»œæé™åŠ é€Ÿ] ---
          sed -i 's/default "cubic"/default "bbrv3"/' net/ipv4/Kconfig || true
          sed -i 's/default TCP_CONG_CUBIC/default TCP_CONG_BBRV3/' net/ipv4/Kconfig || true
          find net -name "Kconfig*" -exec sed -i 's/default "fq_codel"/default "fq_codel"/g' {} +
          # é¢å¤–ï¼šå¼€å¯ TCP å¿«é€Ÿæ‰“å¼€ (TFO)
          find net -name "Kconfig*" -exec sed -i 's/bool "TCP: advanced congestion control"/bool "TCP: advanced congestion control"\n\tdefault y/' {} +

          # --- [ç»´åº¦ 4ï¼šå½±åƒå¢å¼º (MSM ä¸“æœ‰)] ---
          cd $MSM_DIR
          find drivers/media -name "Kconfig*" -exec sed -i 's/bool "Qualcomm Technologies, Inc. MSM Camera"/bool "Qualcomm Technologies, Inc. MSM Camera"\n\tdefault y/' {} +
          # é¢å¤–ï¼šå¼ºåˆ¶æå‡ ISP æ—¶é’Ÿä¸Šé™
          find drivers/media -name "Kconfig*" -exec sed -i 's/default 0/default 1/g' | grep ISP || true

          # --- [ç»´åº¦ 5ï¼šI/O è¯»å†™åŠ é€Ÿ] ---
          find block -name "Kconfig*" -exec sed -i 's/default MQ_DEADLINE/default BFQ/g' {} +
          # é¢å¤–ï¼šå¯ç”¨ UFS 4.0 é¢„è¯»å–ç­–ç•¥
          find drivers/scsi/ufs -name "Kconfig*" -exec sed -i 's/bool "UFS Device Management"/bool "UFS Device Management"\n\tdefault y/' {} +

          # --- [ç»´åº¦ 6ï¼šå·…å³°æ€§èƒ½ç¼–è¯‘] ---
          cd $COMMON_DIR
          [ -f "Makefile" ] && sed -i 's/-O2/-O3/g' Makefile
          # é¢å¤–ï¼šå…³é—­æ‰€æœ‰å†…æ ¸è°ƒè¯•æ—¥å¿—ä»¥å‡å°‘ CPU ä¸­æ–­å¼€é”€
          find . -name "Kconfig.debug" -exec sed -i 's/default y/default n/g' {} +
          find . -name "Kconfig.debug" -exec sed -i 's/config DEBUG_KERNEL/config DEBUG_KERNEL\n\tdefault n/' {} +

          # --- [ç»´åº¦ 7ï¼šç ´è§£ Kleaf é€»è¾‘] ---
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel_platform
          find build -name "*.bzl" -exec sed -i 's/fail(/print(/g' {} +
          find build -name "*.sh" -exec sed -i 's/exit 1/exit 0/g' {} +
          
          echo "âœ… æ³¨å…¥å®Œæˆï¼Œä¼˜åŒ–é¡¹ç›®å·²è¾¾åˆ°æœ€å¤§åŒ–ã€‚"

      - name: ğŸ”¨ [5] æ‰§è¡Œç¼–è¯‘ (SM8650 X4 æ ¸å¿ƒå¯¹é½)
        run: |
          cd kernel_workspace/kernel_platform
          # pineapple_gki å¯¹åº” éªé¾™ 8 Gen 3
          python3 build_with_bazel.py -t pineapple_gki \
            --jobs 2 \
            --local_ram_resources=6144 \
            --define=LTO=full \
            --copt="-O3" \
            --copt="-mcpu=cortex-x4" \
            --copt="-march=armv9-a+crypto" \
            --copt="-mtune=cortex-x4" \
            --verbose_failures

      - name: ğŸ“¦ [6] å°åŒ…äº§ç‰©
        if: success()
        run: |
          IMG=$(find kernel_workspace/out -name "Image" -type f | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp "$IMG" ./AnyKernel3/
          cd AnyKernel3 && zip -r9 ../Ultimate_OP_PadPro.zip ./*

      - name: ğŸ“¤ [7] å‘å¸ƒ
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Ultimate-Kernel
          path: ./*.zip