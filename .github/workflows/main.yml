name: OnePlus_PadPro_Kernel_Factory

on:
  workflow_dispatch:
    inputs:
      custom_command:
        description: '编译指令'
        required: true
        default: 'python3 kernel_platform/build_with_bazel.py -t pineapple gki'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        run: |
          # 腾出空间：删除无用的大型组件
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "清理完成，当前磁盘状态："
          df -h

      - name: Checkout Config
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "KernelBot"
          # 注入 Token 确保拉取私有库或高频率访问不被拦截
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Install Repo Tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

            - name: Sync Source
        run: |
          mkdir -p workspace && cd workspace
          # 1. 在 init 阶段就指定 --depth=1
          repo init -u https://github.com/${{ github.repository }}.git \
                    -b main \
                    -m manifest.xml \
                    --depth=1
          
          # 2. sync 阶段移除 --depth 参数，改用更兼容的写法
          # -j$(nproc) 利用多核加速，--force-sync 确保清理旧残留
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync

      - name: Fix Execution Permissions
        run: |
          cd workspace
          # 遍历所有工具链和脚本并赋予执行权限
          find kernel_platform -name "*.sh" -exec chmod +x {} +
          find kernel_platform -name "bazel" -exec chmod +x {} +
          [ -f kernel_platform/build_with_bazel.py ] && chmod +x kernel_platform/build_with_bazel.py

      - name: Execute Build
        run: |
          cd workspace
          # 执行编译指令
          ${{ github.event.inputs.custom_command }}

      - name: Package AnyKernel3
        if: success()
        run: |
          # 1. 寻找编译产物 Image.gz
          KERNEL_IMAGE=$(find workspace/out -name "Image.gz" | head -n 1)
          if [ -z "$KERNEL_IMAGE" ]; then echo "Image.gz not found"; exit 1; fi
          
          # 2. 克隆 AnyKernel3 模板
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
          
          # 3. 准备打包
          cp "$KERNEL_IMAGE" ak3/
          cd ak3
          # 这里可以根据需要修改 anykernel.sh 的 device.name
          sed -i 's/device.name1=.*/device.name1=OnePlusPadPro/' anykernel.sh
          zip -r9 ../OnePlus_PadPro_Kernel_AK3.zip * -x .git README.md
          
      - name: Upload Kernel Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus_PadPro_Kernel_Package
          path: |
            *.zip
            workspace/out/*/dist/*.ko