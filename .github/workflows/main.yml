name: OnePlus Pad Pro SM8650 Professional Overkill
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ [1] æè‡´æ¸…ç†ä¸ 32GB å†…å­˜æ‰©å®¹
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /usr/local/.ghcup /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /opt/az
          sudo apt-get clean && sudo docker image prune -a -f
          sudo swapoff -a && sudo fallocate -l 32G /swapfile && sudo chmod 600 /swapfile
          sudo mkswap /swapfile && sudo swapon /swapfile && sudo sysctl vm.swappiness=100

      - name: ğŸ“¥ [2] æŒ‰ç…§ Manifest æš´åŠ›æ‹‰å–æºç  (ç»“æ„è¿˜åŸ)
        run: |
          mkdir -p kernel_workspace/kernel_platform && cd kernel_workspace/kernel_platform
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          
          # æ ¸å¿ƒä»£ç 
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650 msm-kernel
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_common_oneplus_sm8650 common
          
          # æ„å»ºç³»ç»Ÿ (è¿™äº›æ˜¯ Bazel èƒ½è¿è¡Œçš„æ ¹åŸº)
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/build/bazel_common_rules build/bazel_common_rules
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/prebuilts/bazel/linux-x86_64 prebuilts/bazel/linux-x86_64
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86 prebuilts/clang/host/linux-x86
          
          # è¿˜åŸ Manifest çš„ linkfile é€»è¾‘
          ln -sf msm-kernel/bazel.WORKSPACE WORKSPACE
          ln -sf msm-kernel/build_with_bazel.py build_with_bazel.py

      - name: â˜¢ï¸ [3] ä¸ƒå¤§ç»´åº¦â€œç§‘å­¦çˆ†ç ´â€æ³¨å…¥ (è§£å†³å†²çªä¸å¹»è§‰)
        run: |
          cd kernel_workspace/kernel_platform
          GKI_CFG="common/arch/arm64/configs/gki_defconfig"
          VND_CFG="msm-kernel/arch/arm64/configs/vendor/pineapple_GKI.config"

          echo "ğŸŒ [ç»´åº¦ 1: ç½‘ç»œ BBRG (å…ˆæ¸…åå†åŠ )]"
          # ä½¿ç”¨ sed åˆ é™¤æ‰€æœ‰å¯èƒ½å†²çªçš„æ‹¥å¡æ§åˆ¶å’Œè°ƒåº¦å™¨é…ç½®
          for cfg in $GKI_CFG $VND_CFG; do
            [ -f "$cfg" ] || continue
            sed -i '/CONFIG_TCP_CONG/d' $cfg
            sed -i '/CONFIG_DEFAULT_TCP_CONG/d' $cfg
            sed -i '/CONFIG_NET_SCH_FQ/d' $cfg
            sed -i '/CONFIG_DEFAULT_NET_SCH/d' $cfg
            # æš´åŠ›æ³¨å…¥æ–°æ ‡å‡†
            {
              echo "CONFIG_TCP_CONG_BBR=y"
              echo "CONFIG_TCP_CONG_BBRV3=y"
              echo "CONFIG_DEFAULT_TCP_CONG=\"bbrv3\""
              echo "CONFIG_NET_SCH_FQ=y"
              echo "CONFIG_DEFAULT_NET_SCH=\"fq\""
              echo "CONFIG_TCP_FASTOPEN=y"
              echo "CONFIG_TCP_LOW_LATENCY=y"
            } >> $cfg
          done
          # TCP åˆå§‹çª—å£ 10 -> 32
          find common/net/ipv4 -name "tcp_ipv4.c" -exec sed -i 's/TCP_INIT_CWND 10/TCP_INIT_CWND 32/g' {} +

          echo "ğŸš€ [ç»´åº¦ 2 & 3: æ€§èƒ½ä¸æ¶æ„ (Makefile å±‚é¢ä¿®å¤)]"
          # æ”¾å¼ƒ Bazel ä¼ å‚ï¼Œç›´æ¥æ”¹ Makefileã€‚é’ˆå¯¹ 8G3 å…¨æ ¸å¿ƒä½¿ç”¨ armv9-a ä¼˜åŒ–ï¼Œä¸é”å®š X4 ä»¥é˜²éæ³•æŒ‡ä»¤
          find . -name "Makefile" -exec sed -i 's/-O2/-O3 -march=armv9-a+crypto -mtune=neoverse-v2/g' {} +
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' $GKI_CFG
          sed -i 's/CONFIG_HZ_250=y/CONFIG_HZ_1000=y/g' $GKI_CFG

          echo "ğŸ§  [ç»´åº¦ 4: å†…å­˜ç®¡ç† MGLRU/ZSTD]"
          sed -i '/CONFIG_LRU_GEN/d' $GKI_CFG
          echo "CONFIG_LRU_GEN=y" >> $GKI_CFG
          echo "CONFIG_LRU_GEN_ENABLED=y" >> $GKI_CFG
          echo "CONFIG_ZRAM_DEF_COMP_ZSTD=y" >> $GKI_CFG

          echo "ğŸ“· [ç»´åº¦ 5: å½±åƒå“åº”ä¸éŸ³è´¨]"
          echo "CONFIG_MSM_CAMERA=y" >> $VND_CFG
          echo "CONFIG_MSM_NPU=y" >> $VND_CFG
          echo "CONFIG_SND_SOC_WCD938X=y" >> $VND_CFG

          echo "ğŸ› ï¸ [ç»´åº¦ 6: ABI çˆ†ç ´ä¸æ„å»ºç¯å¢ƒ]"
          find build -name "*.bzl" -exec sed -i 's/abi_definition =/abi_definition = None #/g' {} +
          find build -name "*.bzl" -exec sed -i 's/kmi_symbol_list =/kmi_symbol_list = None #/g' {} +
          # ç»•è¿‡ Clang ç‰ˆæœ¬æ£€æŸ¥å¯¼è‡´çš„å¤±è´¥
          echo "KBUILD_BUILD_TIMESTAMP=$(date)" >> $GITHUB_ENV

      - name: ğŸ”¨ [4] æ‰§è¡Œå·…å³°ç¼–è¯‘ (ç¯å¢ƒå˜é‡æ³¨å…¥ LTO)
        run: |
          cd kernel_workspace/kernel_platform
          # é€šè¿‡ç¯å¢ƒå˜é‡å¼ºåˆ¶å¼€å¯ LTO
          export LTO=full
          export SKIP_ABI_CHECK=true
          
          python3 build_with_bazel.py -t pineapple gki \
            --jobs $(nproc) \
            --skip_abi_check

      - name: ğŸ“¦ [5] å°åŒ…äº§ç‰©
        run: |
          IMG=$(find kernel_workspace/out -name "Image" -type f | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp "$IMG" ./AnyKernel3/
          cd AnyKernel3 && zip -r9 ../Ultimate_OP_PadPro_Fixed.zip ./*

      - name: ğŸ“¤ [6] å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Ultimate-Scientific
          path: ./*.zip