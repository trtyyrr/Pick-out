name: OnePlus Pad Pro SM8650 Bazel-Package-Fixed
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ [1] ç¯å¢ƒå‡†å¤‡ä¸è™šæ‹Ÿå†…å­˜
        run: |
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc
          sudo swapoff -a && sudo fallocate -l 32G /swapfile && sudo chmod 600 /swapfile
          sudo mkswap /swapfile && sudo swapon /swapfile

      - name: ğŸ“¥ [2] ç»“æ„è¿˜åŸ (ç‰©ç†ä¿®å¤ Bazel Package)
        run: |
          mkdir -p kernel_workspace/kernel_platform && cd kernel_workspace/kernel_platform
          
          # å…‹éš†æ ¸å¿ƒä»£ç 
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650 msm-kernel
          git clone --depth=1 -b oneplus/sm8650_v_15.0.0_pad_pro https://github.com/OnePlusOSS/android_kernel_common_oneplus_sm8650 common
          
          # å…‹éš† CLO ç»„ä»¶
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/build/bazel_common_rules build/bazel_common_rules
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernel_platform/prebuilts/bazel/linux-x86_64 prebuilts/bazel/linux-x86_64
          git clone --depth=1 https://git.codelinaro.org/clo/la/kernelplatform/prebuilts-master/clang/host/linux-x86 prebuilts/clang/host/linux-x86
          
          # ã€å…³é”®ä¿®å¤ã€‘è¿˜åŸ Kleaf æ„å»ºç›®å½•æ˜ å°„
          # æ ¹æ®æŠ¥é”™ï¼ŒBazel æ‰¾ä¸åˆ° build/kernel/kleafï¼Œæˆ‘ä»¬éœ€è¦ä» common ä¸­é“¾æ¥è¿‡å»
          mkdir -p build/kernel
          ln -sf ../../common/build/kleaf build/kernel/kleaf
          
          # ã€æ ¸å¿ƒä¿®å¤ã€‘åˆ›å»ºç¼ºå¤±çš„ BUILD æ–‡ä»¶ä»¥æ»¡è¶³ Bazel Package è¦æ±‚
          touch BUILD
          touch build/BUILD
          touch build/kernel/BUILD
          
          # å»ºç«‹å·¥å…·é“¾é“¾æ¥
          mkdir -p tools
          ln -sf ../prebuilts/bazel/linux-x86_64/bazel tools/bazel
          ln -sf msm-kernel/bazel.WORKSPACE WORKSPACE
          ln -sf msm-kernel/build_with_bazel.py build_with_bazel.py

      - name: â˜¢ï¸ [3] ç‹‚æš´ä¼˜åŒ–æ³¨å…¥ (å…¨é‡ä¸ç¼©å‡)
        run: |
          cd kernel_workspace/kernel_platform
          GKI_CFG="common/arch/arm64/configs/gki_defconfig"
          VND_CFG="msm-kernel/arch/arm64/configs/vendor/pineapple_GKI.config"

          # 1. ç½‘ç»œ BBRG + InitCWND 32
          sed -i '/CONFIG_TCP_CONG/d' $GKI_CFG
          echo "CONFIG_TCP_CONG_BBRV3=y\nCONFIG_DEFAULT_TCP_CONG=\"bbrv3\"\nCONFIG_NET_SCH_FQ=y\nCONFIG_DEFAULT_NET_SCH=\"fq\"\nCONFIG_TCP_FASTOPEN=y" >> $GKI_CFG
          find common/net/ipv4 -name "tcp_ipv4.c" -exec sed -i 's/TCP_INIT_CWND 10/TCP_INIT_CWND 32/g' {} +

          # 2. æ€§èƒ½ 1000Hz + O3 + è§¦æ§é‡‡æ ·
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' $GKI_CFG
          sed -i 's/CONFIG_HZ_250=y/CONFIG_HZ_1000=y/g' $GKI_CFG
          find . -name "Makefile" -exec sed -i 's/-O2/-O3 -march=armv9-a+crypto -mtune=neoverse-v2/g' {} +

          # 3. å†…å­˜ MGLRU + ZSTD + Cache Pressure
          echo "CONFIG_LRU_GEN=y\nCONFIG_LRU_GEN_ENABLED=y\nCONFIG_ZRAM_DEF_COMP_ZSTD=y" >> $GKI_CFG
          sed -i 's/vfs_cache_pressure = 100/vfs_cache_pressure = 130/g' common/kernel/sysctl.c

          # 4. å½±åƒ/éŸ³è´¨/å­˜å‚¨ (UFS 4.0 HPB)
          echo "CONFIG_MSM_CAMERA=y\nCONFIG_MSM_NPU=y\nCONFIG_SND_SOC_WCD938X=y\nCONFIG_SCSI_UFS_HPB=y" >> $VND_CFG

          # 5. ABI çˆ†ç ´ä¸é™å™ª
          find build -name "*.bzl" -exec sed -i 's/abi_definition =/abi_definition = None #/g' {} +
          find build -name "*.bzl" -exec sed -i 's/kmi_symbol_list =/kmi_symbol_list = None #/g' {} +
          echo "CONFIG_SLUB_DEBUG=n\nCONFIG_DEBUG_KERNEL=n" >> $GKI_CFG

      - name: ğŸ”¨ [4] æ‰§è¡Œç¼–è¯‘ (LTO=full)
        run: |
          cd kernel_workspace/kernel_platform
          export LTO=full
          export SKIP_ABI_CHECK=true
          
          # å¼ºåˆ¶æŒ‡å®š Bazel è·¯å¾„
          export PATH=$(pwd)/tools:$PATH
          
          python3 build_with_bazel.py -t pineapple gki \
            --jobs $(nproc) \
            --skip_abi_check

      - name: ğŸ“¦ [5] å°åŒ…
        if: success()
        run: |
          IMG=$(find kernel_workspace/out -name "Image" -type f | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp "$IMG" ./AnyKernel3/
          cd AnyKernel3 && zip -r9 ../Ultimate_SevenDim_Fixed.zip ./*

      - name: ğŸ“¤ [6] å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Ultimate
          path: ./*.zip